{% extends 'base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block header_extra %}
<div id="liveClock" class="live-clock">
    <ion-icon name="time-outline"></ion-icon>
    <span class="live-clock-text"></span>
</div>
{% endblock %}

{% block content %}
{% if show_expiry_widget %}
<div class="card expiry-widget">
    <div class="expiry-widget-header">
        <h3>Expiry Notifications</h3>
        <span class="expiry-widget-note">Stock at risk</span>
    </div>
    <div class="expiry-grid">
        <a class="expiry-tile expiry-expired {% if expiry_counts.expired > 0 %}pulse-strong{% endif %}" href="{% url 'expiry_alerts' %}?tab=expired">
            <div class="expiry-title"><ion-icon name="alert-circle-outline"></ion-icon> Expired</div>
            <div class="expiry-count">{{ expiry_counts.expired }}</div>
            <div class="expiry-note">Action Required</div>
        </a>
        <a class="expiry-tile expiry-critical {% if expiry_counts.critical > 0 %}pulse-strong{% endif %}" href="{% url 'expiry_alerts' %}?tab=critical">
            <div class="expiry-title"><ion-icon name="warning-outline"></ion-icon> Critical (&lt; 45 Days)</div>
            <div class="expiry-count">{{ expiry_counts.critical }}</div>
            <div class="expiry-note">High Risk</div>
        </a>
        <a class="expiry-tile expiry-medium {% if expiry_counts.medium > 0 %}pulse{% endif %}" href="{% url 'expiry_alerts' %}?tab=medium">
            <div class="expiry-title"><ion-icon name="time-outline"></ion-icon> Medium (&lt; 3 Months)</div>
            <div class="expiry-count">{{ expiry_counts.medium }}</div>
            <div class="expiry-note">Watch Zone</div>
        </a>
        <a class="expiry-tile expiry-low {% if expiry_counts.low > 0 %}pulse{% endif %}" href="{% url 'expiry_alerts' %}?tab=low">
            <div class="expiry-title"><ion-icon name="leaf-outline"></ion-icon> Low (&lt; 6 Months)</div>
            <div class="expiry-count">{{ expiry_counts.low }}</div>
            <div class="expiry-note">Monitor</div>
        </a>
    </div>
</div>
{% endif %}
<div class="grid-4">
    <div class="stats-card">
        <div class="stats-label">Today's Sales</div>
        <div class="stats-number">Rs. {{ todays_sales|floatformat:2 }}</div>
    </div>
    <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <div class="stats-label">Low Stock Items</div>
        <div class="stats-number">{{ low_stock }}</div>
    </div>
    <div class="stats-card" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">
        <div class="stats-label">Expired Products</div>
        <div class="stats-number">{{ expired }}</div>
    </div>
    <div class="stats-card" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
        <div class="stats-label">Total Products</div>
        <div class="stats-number">{{ total_products }}</div>
    </div>
</div>

<div class="grid-2 mt-4">
    <div class="card">
        <h3>Recent Sales</h3>
        <table>
            <thead>
                <tr>
                    <th>Invoice</th>
                    <th>Date</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for s in recent_sales %}
                <tr>
                    <td>{{ s.invoice_number }}</td>
                    <td>{{ s.date|date:"Y-m-d" }}</td>
                    <td>{{ s.grand_total|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center">No recent sales</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card">
        <h3>Quick Actions</h3>
        <div class="grid-2">
            <a href="{% url 'pos' %}" class="btn btn-primary">
                <ion-icon name="cart"></ion-icon> New Sale
            </a>
            <a href="{% url 'product_create' %}" class="btn btn-primary"
                style="background: var(--accent); color: #000;">
                <ion-icon name="add-circle"></ion-icon> Add Product
            </a>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const clock = document.getElementById('liveClock');
        if (!clock) {
            return;
        }
        const text = clock.querySelector('.live-clock-text') || clock;
        const dateFormatter = new Intl.DateTimeFormat(undefined, {
            weekday: 'short',
            day: '2-digit',
            month: 'short',
            year: 'numeric',
        });
        const timeFormatter = new Intl.DateTimeFormat(undefined, {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
        });
        const updateClock = () => {
            const now = new Date();
            text.textContent = `${dateFormatter.format(now)} - ${timeFormatter.format(now)}`;
        };
        updateClock();
        setInterval(updateClock, 1000);
    });
</script>
{% endblock %}
